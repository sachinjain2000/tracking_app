<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Counter</title>
    <!-- Reverted to original version -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGFzayBDb3VudGVyIiwic2hvcnRfbmFtZSI6IlRhc2tzIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyMTIxMjEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhabGNuTnBiMjQ5SWpFeUxqQWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5SWpFeU9DSWdhR1ZwWjJoMFBTSXhNamdpSUdacGJHdzlJaU15TVRJeE1qRWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#212121">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent: #000000;
            --success: #10b981;
            --danger: #ef4444;
            --border: #e9ecef;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
            --airtable: #18bfff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 380px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--accent);
        }

        .date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #f0f9ff;
            color: #0284c7;
            border: 1px solid #bae6fd;
        }

        .add-section {
            margin-bottom: 32px;
        }

        .add-form {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .add-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-secondary);
            transition: border-color 0.2s;
        }

        .add-input:focus {
            outline: none;
            border-color: var(--airtable);
        }

        select.add-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .add-btn {
            padding: 14px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-1px);
        }

        .tasks {
            margin-bottom: 32px;
        }

        .task {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .task-count {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }

        .task-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .counter-btn {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 24px;
            font-weight: 700;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Mobile touch optimizations */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .minus-btn {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
            border: 2px solid #f87171;
        }

        .plus-btn {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #16a34a;
            border: 2px solid #4ade80;
        }

        .counter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .counter-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .counter-btn {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 16px;
            }
            
            .task {
                padding: 20px;
                margin-bottom: 12px;
            }
            
            .add-btn {
                padding: 18px 28px;
                font-size: 18px;
            }
            
            /* Disable hover effects on mobile */
            .counter-btn:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .add-btn:hover {
                transform: none;
            }
        }

        .delete-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: var(--danger);
        }

        .end-day-btn {
            width: 100%;
            padding: 18px 24px;
            background: var(--airtable);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: auto;
        }

        .end-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(24, 191, 255, 0.3);
        }

        .end-day-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 14px;
        }

        @media (max-width: 400px) {
            .app {
                max-width: 100%;
            }
            
            .content {
                padding: 16px;
            }
            
            .header {
                padding: 20px 16px 12px;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .setup-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .setup-notice a {
            color: white;
            text-decoration: underline;
        }

        .sync-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-icon {
            font-size: 16px;
        }

        .sync-text {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .sync-status.connected .sync-icon {
            color: var(--success);
        }

        .sync-status.connected .sync-text {
            color: var(--success);
        }

        .sync-status.error .sync-icon {
            color: var(--danger);
        }

        .sync-status.error .sync-text {
            color: var(--danger);
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            border-color: var(--airtable);
            color: var(--airtable);
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>Tasks</h1>
            <div class="date" id="currentDate"></div>
        </div>
        
        <div class="content">
            <div id="status" class="status"></div>
            
            <div class="setup-notice" id="setupNotice">
                🔒 <strong>Secure Version:</strong> No credentials needed! Airtable integration runs securely on the server.
                <br><small>Admin needs to configure backend first.</small>
            </div>
            
            <div class="sync-status" id="syncStatus">
                <div class="sync-info">
                    <span class="sync-icon">🔄</span>
                    <span class="sync-text">Loading task fields...</span>
                </div>
                <button class="refresh-btn" onclick="loadTaskFields()" title="Refresh task list from Airtable">↻</button>
            </div>
            
            <div class="add-section">
                <div class="add-form">
                    <select id="taskSelect" class="add-input">
                        <option value="">Select a task...</option>
                    </select>
                    <button onclick="addTask()" class="add-btn">Add</button>
                </div>
            </div>
            
            <div class="tasks" id="taskList"></div>
            
            <button onclick="endOfDay()" class="end-day-btn" id="endDayBtn">
                End Day - Save to Airtable
            </button>
            
        </div>
    </div>

    <script>
        // Global variables
        let tasks = {};
        let availableFields = [];
        
        // Cache DOM elements for better mobile performance
        let cachedElements = {};
        
        function getElement(id) {
            if (!cachedElements[id]) {
                cachedElements[id] = document.getElementById(id);
            }
            return cachedElements[id];
        }
        
        // Visual feedback instead of audio
        function playIncrementSound() {
            // No audio - just visual feedback
            return;
        }
        
        function playDecrementSound() {
            // No audio - just visual feedback
            return;
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateDate();
            loadData();
            renderTasks();
            
            // Defer non-critical operations for better mobile performance
            setTimeout(() => {
                testBackend();
                loadTaskFields();
            }, 100);
            
            // Add enter key support for dropdown
            document.getElementById('taskSelect').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        });
        
        function updateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }
        
        function loadData() {
            const today = new Date().toISOString().split('T')[0];
            const savedData = localStorage.getItem(`tasks_${today}`);
            if (savedData) {
                tasks = JSON.parse(savedData);
            }
        }
        
        function saveData() {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`tasks_${today}`, JSON.stringify(tasks));
        }
        
        async function testBackend() {
            try {
                const response = await fetch('/.netlify/functions/test-connection');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('setupNotice').style.display = 'none';
                    } else {
                        updateSetupNotice('Backend configured but Airtable connection failed. Check environment variables.');
                    }
                } else {
                    updateSetupNotice('Backend function not found. Make sure to deploy with Netlify Functions.');
                }
            } catch (error) {
                updateSetupNotice('Backend not configured yet. See setup instructions below.');
            }
        }
        
        function updateSetupNotice(message) {
            const notice = document.getElementById('setupNotice');
            notice.innerHTML = `⚠️ <strong>Setup Required:</strong> ${message}`;
        }
        
        async function loadTaskFields() {
            const syncStatus = document.getElementById('syncStatus');
            const syncIcon = syncStatus.querySelector('.sync-icon');
            const syncText = syncStatus.querySelector('.sync-text');
            const refreshBtn = syncStatus.querySelector('.refresh-btn');
            
            try {
                syncIcon.textContent = '🔄';
                syncText.textContent = 'Loading task fields...';
                refreshBtn.disabled = true;
                
                const response = await fetch('/.netlify/functions/get-task-fields');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Task fields response:', result);
                    
                    availableFields = result.fields || [];
                    populateTaskDropdown();
                    
                    if (availableFields.length > 0) {
                        syncIcon.textContent = '✅';
                        syncText.textContent = `${availableFields.length} task fields loaded`;
                        syncStatus.className = 'sync-status connected';
                    } else {
                        syncIcon.textContent = '⚠️';
                        syncText.textContent = result.error || 'No task fields found';
                        syncStatus.className = 'sync-status error';
                        
                        // Show debug info in console
                        if (result.debug) {
                            console.log('Debug info:', result.debug);
                        }
                    }
                } else {
                    throw new Error('Server error: ' + response.status);
                }
                
            } catch (error) {
                console.error('Error loading task fields:', error);
                syncIcon.textContent = '❌';
                syncText.textContent = 'Failed to load task fields';
                syncStatus.className = 'sync-status error';
                
                // Show error in dropdown
                const taskSelect = document.getElementById('taskSelect');
                taskSelect.innerHTML = '<option value="">Error loading tasks</option>';
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        function populateTaskDropdown() {
            const taskSelect = document.getElementById('taskSelect');
            
            // Clear existing options except the first one
            taskSelect.innerHTML = '<option value="">Select a task...</option>';
            
            // Add available fields as options
            availableFields.forEach(fieldName => {
                const option = document.createElement('option');
                option.value = fieldName;
                option.textContent = fieldName;
                taskSelect.appendChild(option);
            });
            
            // Auto-focus on dropdown
            setTimeout(() => {
                taskSelect.focus();
            }, 100);
        }
        
        function addTask() {
            const taskSelect = document.getElementById('taskSelect');
            const taskName = taskSelect.value.trim();
            
            if (!taskName) {
                taskSelect.focus();
                return;
            }
            
            if (tasks[taskName]) {
                showStatus('Task already exists', 'error');
                taskSelect.focus();
                return;
            }
            
            tasks[taskName] = 0;
            taskSelect.value = '';
            saveData();
            renderTasks();
            taskSelect.focus();
        }
        
        function deleteTask(taskName) {
            if (confirm(`Delete "${taskName}"?`)) {
                delete tasks[taskName];
                saveData();
                renderTasks();
            }
        }
        
        function updateCounter(taskName, change) {
            if (tasks[taskName] !== undefined) {
                tasks[taskName] = Math.max(0, tasks[taskName] + change);
                
                // Update UI immediately for maximum responsiveness
                const taskElement = document.querySelector(`[data-task="${taskName}"] .task-count`);
                if (taskElement) {
                    taskElement.textContent = tasks[taskName];
                    // Remove expensive DOM manipulation for mobile
                    const taskContainer = taskElement.parentElement.parentElement;
                    taskContainer.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        taskContainer.style.transform = 'scale(1)';
                    }, 150);
                }
                
                // Save data asynchronously (non-blocking)
                setTimeout(() => saveData(), 0);
            }
        }
        
        function renderTasks() {
            const taskList = getElement('taskList');
            const taskNames = Object.keys(tasks);
            
            if (taskNames.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <h3>No tasks yet</h3>
                        <p>Add your first task above</p>
                    </div>
                `;
                return;
            }
            
            // Use document fragment for better mobile performance
            const fragment = document.createDocumentFragment();
            
            taskNames.forEach(taskName => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
                taskDiv.setAttribute('data-task', taskName);
                
                taskDiv.innerHTML = `
                    <div class="task-info">
                        <div class="task-name">${taskName}</div>
                        <div class="task-count">${tasks[taskName]}</div>
                    </div>
                    <div class="task-controls">
                        <button class="counter-btn minus-btn" onclick="updateCounter('${taskName}', -1)">−</button>
                        <button class="counter-btn plus-btn" onclick="updateCounter('${taskName}', 1)">+</button>
                        <button class="delete-btn" onclick="deleteTask('${taskName}')">×</button>
                    </div>
                `;
                
                fragment.appendChild(taskDiv);
            });
            
            taskList.innerHTML = '';
            taskList.appendChild(fragment);
        }
        
        async function endOfDay() {
            const taskNames = Object.keys(tasks);
            
            if (taskNames.length === 0) {
                showStatus('No tasks to save', 'error');
                return;
            }
            
            const endDayBtn = document.getElementById('endDayBtn');
            endDayBtn.disabled = true;
            endDayBtn.textContent = 'Saving...';
            
            try {
                showStatus('Saving to Airtable...', 'info');
                
                // Send data to Netlify function
                const today = new Date().toISOString().split('T')[0];
                const taskData = {};
                taskNames.forEach(taskName => {
                    taskData[taskName] = tasks[taskName];
                });
                
                const response = await fetch('/.netlify/functions/save-tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: today,
                        tasks: taskData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('✓ Saved to Airtable successfully', 'success');
                    
                    // Clear tasks for next day
                    tasks = {};
                    saveData();
                    renderTasks();
                    
                    // Reset focus to input
                    setTimeout(() => {
                        document.getElementById('taskInput').focus();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to save to Airtable');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Failed to save: ${error.message}`, 'error');
            } finally {
                endDayBtn.disabled = false;
                endDayBtn.textContent = 'End Day - Save to Airtable';
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 4000);
        }
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICd0YXNrLWNvdW50ZXItdjQnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsnLyddOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpCiAgICAgIC50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICByZXR1cm4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICAgIH0pCiAgKTsKfSk7')
                .catch(error => console.log('SW registration failed'));
        }
    </script>
</body>
</html>